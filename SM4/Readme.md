# SM4 实现

## 性能优化依据

本实现以“最大化单核吞吐”为目标，主要优化点如下：

1. **T-Table 合并 S 盒与线性变换 L / L'**
   - 将 `τ`(S 盒) 与 `L`/`L'` 组合为 4 组 256 项查表（按字节位置展开），将每轮的非线性 + 线性变换从多次位运算/旋转压缩为 4 次查表 + 3 次异或。
   - 对加密轮函数与轮密钥扩展分别使用 `L` 与 `L'` 的表，避免在关键路径里频繁调用旋转与组合操作。

2. **轮函数展开（4 轮一组）+ 寄存器滚动状态**
   - 用 `x0..x3` 滚动保存状态，避免 36 字数组读写带来的内存访问与边界检查。
   - 4 轮为一组展开，减少循环控制分支与索引开销，改善指令流水与分支预测。

3. **一次性初始化查表**
   - 查表在首次调用时构建，后续所有密钥扩展与加解密复用，避免每次重复预计算。

上述优化将 SM4 轮函数的关键路径从“字节替换 + 多次旋转 + 多次数组访问”压缩为“查表 + 异或 + 少量寄存器操作”，在常见编译器优化级别下能显著提升吞吐。
